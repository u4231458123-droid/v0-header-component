# MyDispatch Architecture Overview

## System Architecture (Eraser.io Compatible)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│   │  Dashboard  │    │   Fahrer    │    │   Kunden    │    │   Partner   │ │
│   │   Portal    │    │   Portal    │    │   Portal    │    │   Portal    │ │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘ │
│          │                  │                  │                  │         │
│          └──────────────────┼──────────────────┼──────────────────┘         │
│                             │                  │                            │
│                     ┌───────▼──────────────────▼───────┐                   │
│                     │       Next.js App Router          │                   │
│                     │    (Server Components + RSC)      │                   │
│                     └───────────────┬───────────────────┘                   │
│                                     │                                       │
└─────────────────────────────────────┼───────────────────────────────────────┘
                                      │
┌─────────────────────────────────────┼───────────────────────────────────────┐
│                              API LAYER                                       │
├─────────────────────────────────────┼───────────────────────────────────────┤
│                                     │                                       │
│   ┌─────────────────────────────────▼─────────────────────────────────────┐ │
│   │                         Server Actions                                 │ │
│   │              (Data Mutations + Zod Validation)                         │ │
│   └─────────────────────────────────┬─────────────────────────────────────┘ │
│                                     │                                       │
│   ┌─────────────────────────────────▼─────────────────────────────────────┐ │
│   │                          API Routes                                    │ │
│   │             (Webhooks + External Integrations)                         │ │
│   └───────┬─────────────────────────┬─────────────────────────┬───────────┘ │
│           │                         │                         │             │
│           ▼                         ▼                         ▼             │
│   ┌───────────────┐         ┌───────────────┐         ┌───────────────┐    │
│   │   Stripe      │         │    Trigger    │         │    Hugging    │    │
│   │   Webhooks    │         │      .dev     │         │     Face      │    │
│   │               │         │   (Jobs)      │         │     MCP       │    │
│   └───────────────┘         └───────────────┘         └───────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────┼───────────────────────────────────────┐
│                            DATA LAYER                                        │
├─────────────────────────────────────┼───────────────────────────────────────┤
│                                     │                                       │
│   ┌─────────────────────────────────▼─────────────────────────────────────┐ │
│   │                          Supabase                                      │ │
│   │    ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │ │
│   │    │  Database  │  │    Auth    │  │  Storage   │  │  Realtime  │    │ │
│   │    │  (Postgres)│  │   (JWT)    │  │  (S3)      │  │  (WS)      │    │ │
│   │    └────────────┘  └────────────┘  └────────────┘  └────────────┘    │ │
│   │                                                                        │ │
│   │    ┌────────────────────────────────────────────────────────────┐    │ │
│   │    │                   Row Level Security                       │    │ │
│   │    │            (Company-Based Data Isolation)                  │    │ │
│   │    └────────────────────────────────────────────────────────────┘    │ │
│   └────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
User Request
     │
     ▼
┌─────────────┐
│  Middleware │──────────────┐
│   (Auth)    │              │
└──────┬──────┘              │
       │                     │
       ▼                     ▼
┌─────────────┐       ┌─────────────┐
│   Server    │       │  Protected  │
│  Component  │       │   Routes    │
└──────┬──────┘       └──────┬──────┘
       │                     │
       ▼                     ▼
┌─────────────┐       ┌─────────────┐
│   Server    │       │   Client    │
│   Action    │       │  Component  │
└──────┬──────┘       └──────┬──────┘
       │                     │
       ▼                     ▼
┌─────────────────────────────────┐
│         Supabase Client         │
│    (Server-Side / Client-Side)  │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│       Supabase Database         │
│         (with RLS)              │
└─────────────────────────────────┘
```

## Technology Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| Frontend | Next.js 14+ | App Router, Server Components |
| Styling | Tailwind CSS + Shadcn/UI | Design System |
| State | React Server Components | Server-First State |
| Auth | Supabase Auth | JWT-Based Authentication |
| Database | Supabase (PostgreSQL) | Relational Data |
| Storage | Supabase Storage | File Uploads |
| Jobs | Trigger.dev | Background Processing |
| AI | Hugging Face MCP | AI Model Access |
| Payments | Stripe | Subscription & Payments |

## MCP Integration (Nexus Bridge)

```
┌─────────────────────────────────────────────────────────────────┐
│                        AI AGENT (Cursor)                        │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                      NEXUS BRIDGE (MCP)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Resources (Read-Only)           Tools (Executable)            │
│   ┌─────────────────┐             ┌─────────────────┐          │
│   │ project://ui/   │             │  validate_slug  │          │
│   │    tokens       │             │                 │          │
│   ├─────────────────┤             ├─────────────────┤          │
│   │ project://db/   │             │ validate_       │          │
│   │    schema       │             │ compliance      │          │
│   ├─────────────────┤             ├─────────────────┤          │
│   │ project://app/  │             │ scaffold_       │          │
│   │    routes       │             │ feature         │          │
│   ├─────────────────┤             ├─────────────────┤          │
│   │ project://docs/ │             │ get_project_    │          │
│   │    active       │             │ health          │          │
│   └─────────────────┘             └─────────────────┘          │
│                                                                 │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                        PROJECT FILES                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ config/  │  │ types/   │  │  app/    │  │ project_ │       │
│  │ design-  │  │ supabase │  │  routes  │  │ specs.md │       │
│  │ tokens   │  │   .ts    │  │          │  │          │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                          VERCEL                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐    ┌─────────────────┐                   │
│   │   Production    │    │    Preview      │                   │
│   │  (main branch)  │    │  (PR branches)  │                   │
│   └────────┬────────┘    └────────┬────────┘                   │
│            │                      │                             │
│            └──────────┬───────────┘                             │
│                       │                                         │
│                       ▼                                         │
│            ┌──────────────────┐                                │
│            │   Edge Network   │                                │
│            │   (Global CDN)   │                                │
│            └──────────────────┘                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                       SUPABASE                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐    ┌─────────────────┐                   │
│   │   Production    │    │   Development   │                   │
│   │    Project      │    │    Branches     │                   │
│   └─────────────────┘    └─────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Security Model

```
┌─────────────────────────────────────────────────────────────────┐
│                    SECURITY LAYERS                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Layer 1: Authentication (Supabase Auth)                       │
│   ─────────────────────────────────────                         │
│   - JWT-based authentication                                    │
│   - Email/Password + OAuth providers                            │
│   - Session management                                          │
│                                                                 │
│   Layer 2: Authorization (RLS)                                  │
│   ────────────────────────────                                  │
│   - Company-based data isolation                                │
│   - Role-based access control                                   │
│   - NO master-admin policies (DSGVO)                            │
│                                                                 │
│   Layer 3: API Security                                         │
│   ─────────────────────────                                     │
│   - Zod validation for all inputs                               │
│   - Rate limiting                                               │
│   - CORS configuration                                          │
│                                                                 │
│   Layer 4: Infrastructure                                       │
│   ────────────────────────                                      │
│   - HTTPS everywhere                                            │
│   - Environment variables                                       │
│   - GitHub Secrets for CI/CD                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

