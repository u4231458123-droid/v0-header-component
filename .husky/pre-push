#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# MyDispatch - Pre-Push Hook
# =============================================================================
# Basierend auf CPO-Vorgaben
# =============================================================================

echo "üîç Pre-Push Validierung..."
echo -e "==========================\n"

# =============================================================================
# PRE-FLIGHT: PNPM VERF√úGBARKEIT
# =============================================================================

if ! command -v pnpm > /dev/null 2>&1; then
  echo "‚ùå pnpm ist nicht installiert oder nicht im PATH"
  echo "Bitte installiere pnpm: npm install -g pnpm"
  exit 1
fi

# =============================================================================
# PHASE 1: BUILD TEST
# =============================================================================

echo "üèóÔ∏è Phase 1: Build Test..."
pnpm run build || {
  echo -e "\n‚ùå Build fehlgeschlagen - Push abgebrochen"
  exit 1
}

# =============================================================================
# PHASE 2: ABH√ÑNGIGKEITS-PR√úFUNG
# =============================================================================

echo -e "\nüîó Phase 2: Abh√§ngigkeits-Pr√ºfung..."
if [ -f "scripts/cicd/check-dependencies.mjs" ]; then
  node scripts/cicd/check-dependencies.mjs
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 0 ]; then
    echo -e "\n‚úÖ Abh√§ngigkeits-Pr√ºfung erfolgreich"
  else
    # Alle Exit-Codes au√üer 0 werden als Fehler behandelt
    echo -e "\n‚ùå Abh√§ngigkeits-Pr√ºfung fehlgeschlagen (Exit-Code: $EXIT_CODE) - Push abgebrochen"
    exit 1
  fi
else
  echo "‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfungs-Script nicht gefunden - √ºberspringe"
fi

echo -e "\n‚úÖ Pre-Push Validierung erfolgreich!"
