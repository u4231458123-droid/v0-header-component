#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# MyDispatch - Pre-Push Hook
# =============================================================================
# Basierend auf CPO-Vorgaben
# =============================================================================

echo "üîç Pre-Push Validierung..."
echo -e "==========================\n"

# =============================================================================
# PHASE 1: BUILD TEST
# =============================================================================

echo "üèóÔ∏è Phase 1: Build Test..."
timeout 300 npm run build || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ùå Build hat Timeout (300s) - Push abgebrochen"
  else
    echo -e "\n‚ùå Build fehlgeschlagen - Push abgebrochen"
  fi
  exit 1
}

# =============================================================================
# PHASE 2: ABH√ÑNGIGKEITS-PR√úFUNG
# =============================================================================

echo -e "\nüîó Phase 2: Abh√§ngigkeits-Pr√ºfung..."
if [ -f "scripts/cicd/check-dependencies.mjs" ]; then
  # Timeout: 30 Sekunden, dann abbrechen
  timeout 30 node scripts/cicd/check-dependencies.mjs
  EXIT_CODE=$?
  
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfung hat Timeout (30s) - √ºberspringe"
  elif [ $EXIT_CODE -eq 1 ]; then
    echo -e "\n‚ùå Abh√§ngigkeits-Pr√ºfung: Kritische Fehler gefunden - Push abgebrochen"
    exit 1
  elif [ $EXIT_CODE -eq 0 ]; then
    echo -e "\n‚úÖ Abh√§ngigkeits-Pr√ºfung erfolgreich"
  else
    echo -e "\n‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfung hat Warnungen gefunden (nicht blockierend)"
  fi
else
  echo "‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfungs-Script nicht gefunden - √ºberspringe"
fi

echo -e "\n‚úÖ Pre-Push Validierung erfolgreich!"
