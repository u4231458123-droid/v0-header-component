#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# MyDispatch - Pre-Commit Hook
# =============================================================================
# Basierend auf CPO-Vorgaben und AAAPlanung/planung.txt
# =============================================================================

echo "üîç Pre-Commit Validierung..."
echo -e "============================\n"

# =============================================================================
# PHASE 1: LINTING
# =============================================================================

echo "üßπ Phase 1: Linting..."
timeout 120 npm run lint || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ùå Linting hat Timeout (120s) - Commit abgebrochen"
  else
    echo -e "\n‚ùå Linting fehlgeschlagen - Commit abgebrochen"
  fi
  exit 1
}

# =============================================================================
# PHASE 2: TYPE CHECKING
# =============================================================================

echo -e "\nüìò Phase 2: Type Checking..."
timeout 120 npm run type-check || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ùå Type Checking hat Timeout (120s) - Commit abgebrochen"
  else
    echo -e "\n‚ùå Type Checking fehlgeschlagen - Commit abgebrochen"
  fi
  exit 1
}

# =============================================================================
# PHASE 3: DESIGN-VALIDIERUNG
# =============================================================================

echo -e "\nüé® Phase 3: Design-Validierung..."
if [ -f "scripts/cicd/validate-design.mjs" ]; then
  timeout 60 node scripts/cicd/validate-design.mjs || {
    EXIT_CODE=$?
    if [ $EXIT_CODE -eq 124 ]; then
      echo -e "\n‚ùå Design-Validierung hat Timeout (60s) - Commit abgebrochen"
    else
      echo -e "\n‚ùå Design-Validierung fehlgeschlagen - Commit abgebrochen"
    fi
    exit 1
  }
else
  echo "‚ö†Ô∏è Design-Validierungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.5: ABH√ÑNGIGKEITS-PR√úFUNG
# =============================================================================

echo -e "\nüîó Phase 3.5: Abh√§ngigungs-Pr√ºfung..."
if [ -f "scripts/cicd/check-dependencies.mjs" ]; then
  # Timeout: 30 Sekunden, dann abbrechen
  timeout 30 node scripts/cicd/check-dependencies.mjs
  EXIT_CODE=$?
  
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfung hat Timeout (30s) - √ºberspringe"
  elif [ $EXIT_CODE -eq 1 ]; then
    echo -e "\n‚ùå Abh√§ngigkeits-Pr√ºfung: Kritische Fehler gefunden - Commit abgebrochen"
    exit 1
  elif [ $EXIT_CODE -eq 0 ]; then
    echo -e "\n‚úÖ Abh√§ngigkeits-Pr√ºfung erfolgreich"
  else
    echo -e "\n‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfung hat Warnungen gefunden (nicht blockierend)"
  fi
else
  echo "‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.6: SQL-VALIDIERUNG
# =============================================================================

echo -e "\nüóÑÔ∏è Phase 3.6: SQL-Dateien-Validierung..."
if [ -f "scripts/cicd/validate-sql-files.mjs" ]; then
  timeout 60 node scripts/cicd/validate-sql-files.mjs || {
    EXIT_CODE=$?
    if [ $EXIT_CODE -eq 124 ]; then
      echo -e "\n‚ùå SQL-Validierung hat Timeout (60s) - Commit abgebrochen"
    else
      echo -e "\n‚ùå SQL-Validierung fehlgeschlagen - Commit abgebrochen"
    fi
    exit 1
  }
else
  echo "‚ö†Ô∏è SQL-Validierungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.7: CPO AGENT VALIDIERUNG (Design, Code-Qualit√§t, DSGVO)
# =============================================================================

echo -e "\nü§ñ Phase 3.7: CPO Agent Validierung..."
if [ -f "lib/ai/cpo-agent-integration.ts" ]; then
  # Hole ge√§nderte Dateien
  CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?|jsx?)$' || true)
  
  if [ -n "$CHANGED_FILES" ]; then
    echo "üìù Ge√§nderte Dateien gefunden - CPO Agent wird validieren..."
    # CPO Agent Validierung wird in CI/CD Pipeline ausgef√ºhrt
    # Hier nur Warnung ausgeben
    echo "‚ö†Ô∏è CPO Agent Validierung wird in CI/CD Pipeline ausgef√ºhrt"
  else
    echo "‚úÖ Keine ge√§nderten TypeScript/JavaScript-Dateien"
  fi
else
  echo "‚ö†Ô∏è CPO Agent Integration nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 4: LINT-STAGED (Formatierung)
# =============================================================================

echo -e "\n‚ú® Phase 4: Auto-Formatierung..."
timeout 60 npx lint-staged || {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo -e "\n‚ö†Ô∏è Lint-staged hat Timeout (60s) - √ºberspringe"
  else
    echo -e "\n‚ö†Ô∏è Lint-staged hat Warnungen (nicht blockierend)"
  fi
}

echo -e "\n‚úÖ Pre-Commit Validierung erfolgreich!"
