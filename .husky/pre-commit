#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# MyDispatch - Pre-Commit Hook
# =============================================================================
# Basierend auf CPO-Vorgaben und AAAPlanung/planung.txt
# =============================================================================

echo "üîç Pre-Commit Validierung..."
echo -e "============================\n"

# =============================================================================
# PHASE 1: LINTING
# =============================================================================

echo "üßπ Phase 1: Linting..."
npm run lint || {
  echo -e "\n‚ùå Linting fehlgeschlagen - Commit abgebrochen"
  exit 1
}

# =============================================================================
# PHASE 2: TYPE CHECKING
# =============================================================================

echo -e "\nüìò Phase 2: Type Checking..."
npm run type-check || {
  echo -e "\n‚ùå Type Checking fehlgeschlagen - Commit abgebrochen"
  exit 1
}

# =============================================================================
# PHASE 3: DESIGN-VALIDIERUNG
# =============================================================================

echo -e "\nüé® Phase 3: Design-Validierung..."
if [ -f "scripts/cicd/validate-design.mjs" ]; then
  node scripts/cicd/validate-design.mjs || {
    echo -e "\n‚ùå Design-Validierung fehlgeschlagen - Commit abgebrochen"
    exit 1
  }
else
  echo "‚ö†Ô∏è Design-Validierungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.5: ABH√ÑNGIGKEITS-PR√úFUNG
# =============================================================================

echo -e "\nüîó Phase 3.5: Abh√§ngigkeits-Pr√ºfung..."
if [ -f "scripts/cicd/check-dependencies.mjs" ]; then
  node scripts/cicd/check-dependencies.mjs || {
    echo -e "\n‚ùå Abh√§ngigkeits-Pr√ºfung fehlgeschlagen - Commit abgebrochen"
    exit 1
  }
else
  echo "‚ö†Ô∏è Abh√§ngigkeits-Pr√ºfungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.6: SQL-VALIDIERUNG
# =============================================================================

echo -e "\nüóÑÔ∏è Phase 3.6: SQL-Dateien-Validierung..."
if [ -f "scripts/cicd/validate-sql-files.mjs" ]; then
  node scripts/cicd/validate-sql-files.mjs || {
    echo -e "\n‚ùå SQL-Validierung fehlgeschlagen - Commit abgebrochen"
    exit 1
  }
else
  echo "‚ö†Ô∏è SQL-Validierungs-Script nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 3.7: CPO AGENT VALIDIERUNG (Design, Code-Qualit√§t, DSGVO)
# =============================================================================

echo -e "\nü§ñ Phase 3.7: CPO Agent Validierung..."
if [ -f "lib/ai/cpo-agent-integration.ts" ]; then
  # Hole ge√§nderte Dateien
  CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?|jsx?)$' || true)

  if [ -n "$CHANGED_FILES" ]; then
    echo "üìù Ge√§nderte Dateien gefunden - CPO Agent wird validieren..."
    # CPO Agent Validierung wird in CI/CD Pipeline ausgef√ºhrt
    # Hier nur Warnung ausgeben
    echo "‚ö†Ô∏è CPO Agent Validierung wird in CI/CD Pipeline ausgef√ºhrt"
  else
    echo "‚úÖ Keine ge√§nderten TypeScript/JavaScript-Dateien"
  fi
else
  echo "‚ö†Ô∏è CPO Agent Integration nicht gefunden - √ºberspringe"
fi

# =============================================================================
# PHASE 4: LINT-STAGED (Formatierung)
# =============================================================================

echo -e "\n‚ú® Phase 4: Auto-Formatierung..."
npx lint-staged || {
  echo -e "\n‚ö†Ô∏è Lint-staged hat Warnungen (nicht blockierend)"
}

echo -e "\n‚úÖ Pre-Commit Validierung erfolgreich!"
