#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# MANDATORY QUALITY GATE - NICHT UMG-EHBAR
echo ""
echo "ğŸš¨ MANDATORY QUALITY GATE - Pre-Commit Check"
echo "=============================================="
echo ""

# Phase 1: TypeScript-PrÃ¼fung
echo "ğŸ“‹ Phase 1: TypeScript-PrÃ¼fung..."
if ! pnpm exec tsc --noEmit --pretty false 2>&1 | grep -q "error TS"; then
  echo "âœ… TypeScript-PrÃ¼fung bestanden"
else
  echo ""
  echo "âŒ TYPESCRIPT-FEHLER GEFUNDEN - Commit blockiert!"
  echo "ğŸ’¡ FÃ¼hre 'pnpm exec tsc --noEmit' aus, um die Fehler zu sehen."
  echo ""
  exit 1
fi

# Phase 2: Linter-Check
echo "ğŸ“‹ Phase 2: Linter-Check..."
if ! pnpm exec eslint . --max-warnings 0 --quiet 2>&1 | grep -q "error"; then
  echo "âœ… Linter-Check bestanden"
else
  echo ""
  echo "âŒ LINTER-FEHLER GEFUNDEN - Commit blockiert!"
  echo "ğŸ’¡ FÃ¼hre 'pnpm exec eslint .' aus, um die Fehler zu sehen."
  echo ""
  exit 1
fi

# Phase 3: Bot-Validation
echo "ğŸ“‹ Phase 3: Bot-Validation..."
node scripts/cicd/mandatory-quality-gate.js --pre-commit

# Exit-Code prÃ¼fen
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ QUALITY GATE FEHLGESCHLAGEN - Commit blockiert!"
  echo "ğŸ’¡ Behebe die Fehler und versuche es erneut."
  echo ""
  exit 1
fi

echo ""
echo "âœ… ALLE PRÃœFUNGEN BESTANDEN - Commit erlaubt"
echo ""

