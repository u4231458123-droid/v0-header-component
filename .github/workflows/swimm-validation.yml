# ============================================================================
# Swimm Documentation Validation
# ============================================================================
# PrÃ¼ft ob Code und Dokumentation synchron sind.
# Blockiert Merge wenn Dokumentation veraltet ist.
# ============================================================================

name: Swimm Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  swimm-verify:
    name: Verify Documentation Sync
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          
      - name: Install Swimm CLI
        run: npm install -g @swimm/cli
        
      - name: Verify Documentation
        id: verify
        run: |
          echo "ðŸ” PrÃ¼fe Dokumentations-Synchronisation..."
          
          # PrÃ¼fe ob .swimm Ordner existiert
          if [ ! -d ".swimm" ]; then
            echo "âš ï¸ Kein .swimm Ordner gefunden - Ã¼berspringe Validierung"
            echo "has_swimm=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_swimm=true" >> $GITHUB_OUTPUT
          
          # Versuche Swimm-Validierung (wenn konfiguriert)
          if command -v swimm &> /dev/null; then
            swimm verify --ci || {
              echo "âŒ Dokumentation ist nicht synchron mit Code"
              echo "   Bitte aktualisiere die Swimm-Docs vor dem Merge"
              echo "sync_status=outdated" >> $GITHUB_OUTPUT
              exit 1
            }
            echo "sync_status=synced" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Swimm CLI nicht verfÃ¼gbar"
            echo "sync_status=unknown" >> $GITHUB_OUTPUT
          fi
          
      - name: Check Changed Files
        if: steps.verify.outputs.has_swimm == 'true'
        run: |
          # PrÃ¼fe ob Code-Dateien ohne Doku-Updates geÃ¤ndert wurden
          CHANGED_CODE=$(git diff --name-only origin/main...HEAD | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' | wc -l)
          CHANGED_DOCS=$(git diff --name-only origin/main...HEAD | grep -E '\.swimm/|\.md$' | wc -l)
          
          echo "ðŸ“Š Ã„nderungs-Statistik:"
          echo "   - Code-Dateien: $CHANGED_CODE"
          echo "   - Doku-Dateien: $CHANGED_DOCS"
          
          # Warnung wenn viel Code aber wenig Doku geÃ¤ndert
          if [ "$CHANGED_CODE" -gt 10 ] && [ "$CHANGED_DOCS" -lt 2 ]; then
            echo "âš ï¸ Viele Code-Ã„nderungen ($CHANGED_CODE) aber wenige Doku-Updates ($CHANGED_DOCS)"
            echo "   Bitte Dokumentation prÃ¼fen und aktualisieren"
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## Swimm Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outputs.has_swimm }}" == "true" ]; then
            echo "âœ… Swimm-Konfiguration gefunden" >> $GITHUB_STEP_SUMMARY
            
            case "${{ steps.verify.outputs.sync_status }}" in
              "synced")
                echo "âœ… Dokumentation ist synchron mit Code" >> $GITHUB_STEP_SUMMARY
                ;;
              "outdated")
                echo "âŒ Dokumentation ist veraltet" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "âš ï¸ Sync-Status unbekannt" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          else
            echo "âš ï¸ Keine Swimm-Konfiguration gefunden" >> $GITHUB_STEP_SUMMARY
          fi

